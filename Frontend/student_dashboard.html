<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard | CampusFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .form-card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; object-fit: cover; border: 3px solid #007bff; }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-12 d-flex align-items-center bg-white p-3 shadow-sm rounded">
            <img src="/static/profile_pics/{{ current_user.image_file }}" class="rounded-circle profile-img me-3">
            <div>
                <h3 class="mb-0 fw-bold">{{ current_user.full_name }}</h3>
                <p class="text-muted mb-0">Roll No: {{ current_user.username }} | Student Portal</p>
            </div>
            <a href="/logout" class="btn btn-outline-danger ms-auto fw-bold">Logout</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card p-4 form-card bg-white">
                <h4 class="fw-bold mb-4 text-primary">New Application</h4>
                <form action="/submit" method="POST">
                    
                    <label class="form-label fw-bold">Select Request Type</label>
                    <select name="request_type" id="request_type" class="form-select mb-3" onchange="toggleFields()" required>
                        <option value="OD">On-Duty (OD)</option>
                        <option value="GatePass">Gate Pass</option>
                        <option value="Leave">Leave Application</option>
                    </select>

                    <label class="form-label fw-bold">Date</label>
                    <input type="date" name="od_date" class="form-control mb-3" required>

                    <div id="time_section" style="display: none;">
                        <div class="row mb-3">
                            <div class="col">
                                <label class="small fw-bold text-danger">Exit Time</label>
                                <input type="time" name="exit_time" class="form-control">
                            </div>
                            <div class="col">
                                <label class="small fw-bold text-danger">Return Time</label>
                                <input type="time" name="return_time" class="form-control">
                            </div>
                        </div>
                        <div class="alert alert-info py-2 small">Note: Gate Pass expires automatically after return time.</div>
                    </div>

                    <label class="form-label fw-bold">Detailed Reason</label>
                    <textarea name="reason" class="form-control mb-4" rows="3" placeholder="Provide full details for AI verification..." required></textarea>

                    <button type="submit" class="btn btn-primary w-100 fw-bold py-2">Submit Request</button>
                </form>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card p-4 form-card bg-white">
                <h4 class="fw-bold mb-4">Your Request History</h4>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>AI Summary</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in requests %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ r.request_type }}</span></td>
                                <td><small class="text-muted">
                                     {{ r.summary }} 
                                    </small>
                                </td>
                                <td>
    {% set current_date = now_date() %} {# We will define this function in app.py #}
    
    {% if r.status == 'Approved' %}
        {% if r.od_date < current_date %}
            <span class="badge bg-danger">Expired</span>
            <small class="d-block text-muted">Date passed</small>
        {% elif r.request_type == 'GatePass' and r.return_time and r.od_date == current_date and now_time() > r.return_time %}
            <span class="badge bg-danger">Expired</span>
            <small class="d-block text-muted">Time exceeded</small>
        {% else %}
            <span class="badge bg-success">Approved</span>
            <br><a href="/download/{{ r.id }}" class="small">Download PDF</a>
        {% endif %}
    {% elif r.status == 'Pending' %}
        <span class="badge bg-warning text-dark">Pending</span>
    {% else %}
        <span class="badge bg-secondary">{{ r.status }}</span>
    {% endif %}
</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleFields() {
        var type = document.getElementById("request_type").value;
        var timeSection = document.getElementById("time_section");
        
        // Logical check: Show time inputs only if "GatePass" is selected
        if (type === "GatePass") {
            timeSection.style.display = "block";
        } else {
            timeSection.style.display = "none";
        }
    }
</script>

</body>
</html>
